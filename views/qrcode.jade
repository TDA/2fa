extends layout

block content
  div.smallBox
    h1= title
    p Username you selected is #{uname}
    p Password you selected is #{pass}
    p Secret is #{secret}
    p You chose to turn on 2fa #{twoFa}
    p Please scan the QR code with your Google Authenticator App.
    !{imgData}
    p Let's verify your setup:
      p Please enter the 6-digit code generated by your Google Authenticator app below:
        label(for="code") 6-Digit Code:
          input(type = "text", name = "code", id = "code", placeholder = "Enter the 6-Digit Code")
        input(type = "button", name = "verify", id = "verify", value = "Verify")
    p(class = "hint")
  script(src = '/scripts/verify.js')
  script.
    $(document).ready(function(){
      var code = $('#code');
      var verifyButton = $("#verify");
      var hint = $('.hint');
      hint.hide();
      verifyButton.click(function() {
        if(validate(code.val()) !== true){
         code.focus();
         hint.html('Please enter a valid code');
         code.setCustomValidity('The code must be 6 digits');
         return false;
        }
        $.ajax({
          'url' : '/verify',
          'method': 'POST',
          'data': {
            'secret' : '#{secret}',
            'code' : $('#code').val()
          }
        }).done(function(result){
          if(result == "true"){
            // the codes matched, so display a success message, and redirect to the regular sync flow.
            // for now, hide the controls, but redirect using backbone in the real one
            $(".smallBox > :not('.hint')").hide('fast');
            hint.html('You have successfully set up 2-Factor Authentication with Google Authenticator');
            hint.append('<p><a href="/random">Regular flow link</a></p>');
            hint.show(500);
          }
          else{
            hint.html('The codes did not match, please enter the latest code generated by Google Authenticator');
            code.setCustomValidity('Please enter a new code');
            hint.show();
          }
        });
      });
    });


